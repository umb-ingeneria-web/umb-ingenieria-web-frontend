steps:
  # Step 0: Generar .env para variables públicas usadas en build (Vite/SvelteKit)
  - name: 'gcr.io/cloud-builders/gcloud'
    id: 'write-env'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        printf "VITE_API_BASE_URL=%s\n" "${_VITE_API_BASE_URL}" > .env

  # Step 1: Construir la imagen Docker
  - name: 'gcr.io/cloud-builders/docker'
    id: 'build-image'
    args:
      - 'build'
      - '-t'
      - '${_REGION}-docker.pkg.dev/${PROJECT_ID}/${_REPOSITORY}/${_IMAGE_NAME}:${SHORT_SHA}'
      - '-t'
      - '${_REGION}-docker.pkg.dev/${PROJECT_ID}/${_REPOSITORY}/${_IMAGE_NAME}:latest'
      - '-f'
      - 'Dockerfile'
      - '.'
    timeout: '600s'

  # Step 2: Subir la imagen a Artifact Registry
  - name: 'gcr.io/cloud-builders/docker'
    id: 'push-image'
    args:
      - 'push'
      - '${_REGION}-docker.pkg.dev/${PROJECT_ID}/${_REPOSITORY}/${_IMAGE_NAME}:${SHORT_SHA}'
    waitFor: ['build-image']

  - name: 'gcr.io/cloud-builders/docker'
    id: 'push-image-latest'
    args:
      - 'push'
      - '${_REGION}-docker.pkg.dev/${PROJECT_ID}/${_REPOSITORY}/${_IMAGE_NAME}:latest'
    waitFor: ['build-image']

  # Step 3: Validar que el servicio ya existe (si no existe, fallar el build)
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    id: 'check-cloud-run-service'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        set -e
        echo "Checking Cloud Run service exists: ${_SERVICE_NAME} (${_REGION})"
        gcloud run services describe "${_SERVICE_NAME}" --region "${_REGION}" --platform managed >/dev/null
    waitFor: ['push-image']

  # Step 4: Actualizar imagen en Cloud Run (solo update; NO crea el servicio)
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    id: 'update-cloud-run'
    entrypoint: gcloud
    args:
      - 'run'
      - 'services'
      - 'update'
      - '${_SERVICE_NAME}'
      - '--image'
      - '${_REGION}-docker.pkg.dev/${PROJECT_ID}/${_REPOSITORY}/${_IMAGE_NAME}:${SHORT_SHA}'
      - '--region'
      - '${_REGION}'
      - '--platform'
      - 'managed'
      - '--port'
      - '80'
      - '--memory'
      - '512Mi'
      - '--cpu'
      - '1'
      - '--max-instances'
      - '10'
      - '--min-instances'
      - '0'
    waitFor: ['check-cloud-run-service']

timeout: '1200s'

options:
  machineType: 'E2_MEDIUM'
  logging: CLOUD_LOGGING_ONLY

images:
  - '${_REGION}-docker.pkg.dev/${PROJECT_ID}/${_REPOSITORY}/${_IMAGE_NAME}:${SHORT_SHA}'
  - '${_REGION}-docker.pkg.dev/${PROJECT_ID}/${_REPOSITORY}/${_IMAGE_NAME}:latest'


# Variables de sustitución con valores por defecto
substitutions:
  _REGION: 'us-east4'
  _REPOSITORY: 'repository'
  _IMAGE_NAME: 'image-front'
  _SERVICE_NAME: 'image-front-frontend-service'
  _VITE_API_BASE_URL: ''
